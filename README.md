Cordwood
========

cordwood 是一个基于 Spring
框架的web插件容器，可实现基于cordwood插件API的插件包热拔插。

 

目录结构
--------

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
cordwood
    - doc //文档
    - LICENSE //许可证
    - README.md //本文档
    - source //cordwood核心代码
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

 

工程结构
--------

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
cordwood
    - cordwood-console //控制台程序（插件容器、插件管理）
    - cordwood-core //核心类库
    - cordwood-mobile //移动端工具库
    - cordwood-oauth2-server //基于oauth2协议的单点登录服务器
    - cordwood-plugin //插件核心类库（插件开发SDK）
    - cordwood-plugin-advance //示例高级插件（HTML渲染+数据库访问）
    - cordwood-plugin-pojo //示例POJO插件
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

 

依赖关系
--------

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
cordwood-console
    - cordwood-core
cordwood-mobile
cordwood-oauth2-server
cordwood-plugin
    - cordwood-core
cordwood-plugin-advance
    - cordwood-core
    - cordwood-plugin
cordwood-plugin-pojo
    - cordwood-core
    - cordwood-plugin
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

 

词汇表
------

| 控制台 Home 目录    | cordwood-console 运行所产生的程序数据根目录                                                 |
|---------------------|---------------------------------------------------------------------------------------------|
| 插件 web 根路径     | 表示所有插件 web URL 的根路径，即 service 目录：http://localhost:8000/service               |
| 插件 web 资源根路径 | 表示所有插件静态资源的 web URL 的根路径，即 resources 目录：http://localhost:8000/resources |

 

启动 cordwood 控制台
--------------------

当需要安装部署插件来验证功能时，需要启动控制台程序，然后将插件安装到控制台，再进行访问。

 

### 用 IDE 调试模式启动

build.gradle 默认提供了eclipse插件配置项，因此可以直接导入到 eclipse 及 eclipse
衍生类 IDE，因为使用了 spring-boot，所以建议使用 eclipse 的 spring boot
插件来启动，具体的，在安装了 spring 插件后，打开 “Boot Dashboard”，在列表中选中
cordwood-console，选择 debug，等待控制台启动成功。

 

以此方式启动控制台后，home 目录将位于：

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
.../cordwood-console/home-not-set/
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

 

### 用脚本方式运行

对于不需要调试控制台程序的场景，可以将控制台程序打包，然后通过脚本来运行，具体做法如下：

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
cd {source 目录}
./package.sh
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

执行完毕后，将在source目录下生成一个 dist 目录，结构如下：

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
app.war  控制台可执行文件
README.md 发行包介绍信息（发行包中各个脚本使用方法，见此文件）
run.bat
run.sh
setenv.bat
setenv.sh
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

执行 ./run.sh start 来启动控制台程序。

 

以此方式启动控制台后，home 目录将位于：

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
.../dist/data
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

 

控制台 Home 目录结构
--------------------

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
cache   - 缓存
config  - 配置
data    - 数据
    attachment - 附件
    backups - 备份
    database - 数据库
    plugins - 插件安装目录
libs    - 插件所依赖的类库
logs    - 日志
temp    - 临时
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

 

开发插件
--------

在对整个 cordwood 根工程编译后

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
source/gradlew clean build -x test
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

将生成的插件包开发所需API类库文件（如下）复制到你自己的插件工程任意目录，然后将其添加到构建路径中

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
cordwood-core/build/libs/cordwood-core-0.0.1.RELEASE.jar
cordwood-plugin/build/libs/cordwood-plugin-0.0.1.RELEASE.jar
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

 

安装插件包
----------

启动cordwood控制台之后，将插件工程编译打包得到的 .jar
文件上传到控制台即完成安装。

 

注意：请不要在控制台正在启动或停止的时候，安装、更新或卸载插件，因为插件包的变化会登记到数据库中，而控制台正在启动/停止的时候，数据库连接也许暂时无法使用。

 

卸载/更新插件包
---------------

在cordwood控制台重新上传插件包，新插件包会覆盖标识相同的老插件包，完成更新；在插件管理页面可以卸载已安装的插件。

 

部署插件依赖的类库
------------------

对于使用了第三方类库的插件包，在启动 cordwood 控制台之前，需要将所依赖的 .jar
文件复制到：

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
控制台home目录/libs
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

这些依赖的类库只在控制台启动期间会加载一次，所以在控制台运行期间，复制新的依赖包到此目录是无效的，需要通过重启控制台使其生效。

 

访问安装的插件功能
------------------

所有的插件被安装后，通过访问：

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
http://host:port/service/{plugin name}/{plugin function}
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

来调用插件功能。

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
@Pluggable(
    name = "demo",  // plugin name 即取的此属性值
    version = "1.0.0")
public class ... {

    @Functional(
        name = "hello",  //plugin function 即取的此属性值
        resultType = "text/html" )
    public String ... () {}

}
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

 

cordwood-console web服务
------------------------

cordwood-console
对于需要调用插件功能的客户端提供了若干web服务，以便支撑诸如插件访问授权等需求。

 

### web服务规范

对于接口访问的请求示例，若支持POST，则给出POST
报文样例（仅供参考，若要调试，请使用调试工具自行按要求设置入参），否则给出GET样例，若同时支持，则只给出POST样例，GET方式的请求，请参见HTTP规范自行组织。

对于入参组织结构，若入参为非结构化数据（比如：登录账号、密码，无需作为对象结构传入），则均采用
application/x-www-form-urlencoded 内容类型，否则，采用 application/json。

 

**连接参数**

host: 192.168.10.70

port: 8001

请在构造API地址时，将 **host** 和 **port** 部分用上述参数替换

 

**安全性**

所有 API 均通过传输秘钥来对请求信息签名，以此保证信息不被篡改

transfer_key : 51f72611acf6df792025ae5ce341b01f

 

入参签名算法为 SHA1。具体签名规则如下：

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
sign = sha1( (k1=v1&k2=v2...) + transfer_key )
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

其中，k1=v1&k2=v2... 为参数键值列表，列表中的每一项格式为
“键=值”，列表项需要根据键名升序排列，然后用 “&” 进行连接。最后将数据传输秘钥
transfer_key 拼接至尾端（不含 + 号）。整体作 sha1 运算得到最终的签名。

由于所有 API 入参均需签名，因此接口详细定义节不在赘述该参数含义。

 

**通用响应格式**

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
{
  "code" : 1,
  "message" : "本地化错误消息",
  "body" : {
    ...
  }
}
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

 

**响应通用字段说明**

| 字段    | 含义                | 必传 | 备注                                                              |
|---------|---------------------|------|-------------------------------------------------------------------|
| code    | 本次 API 调用的结果 | Y    | 指示API调用过程是否完整（无网络错误或异常），详见接口常量定义一节 |
| message | 异常或错误调试信息  | N    |                                                                   |
| body    | 响应的数据根节点    | N    | 根据具体业务逻辑，非数据接口可能不包含该节点                      |

 

**常量定义**

| 代码 | 含义                     |
|------|--------------------------|
| \-2  | 未知错误 （联系技术）    |
| \-1  | 系统内部错误（联系技术） |
| 1    | 成功                     |
| 2    | API 已禁用               |
| 3    | 访问未经授权             |
| 4    | 请求参数错误             |
| 5    | 请求参数签名错误         |

 

**业务错误代码**

| 代码 | 含义 |
|------|------|
|      |      |

 

### 认证及授权接口

客户端通过管理员分配的应用 appkey 和 appsk 调用此接口获取插件功能访问权限。

地址：http://host:port/api/authenticate

方法：POST

 

**入参**

| 字段     | 含义             | 必传 | 备注       |
|----------|------------------|------|------------|
| app_key  | 应用唯一标识     | Y    |            |
| app_sk   | 应用秘钥         | Y    |            |
| interval | 此次授权有效时长 | Y    | 单位为分钟 |

 

**响应**

| 字段        | 含义                                   |
|-------------|----------------------------------------|
| accessToken | 鉴权码（调用其他接口或插件服务的凭据） |
| expiry      | 到期时间（1970年距今的毫秒数）         |

 

响应示例

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
{
  "code": "1",
  "body": {
    "success": true,
    "data": {
      "expiry": "1483948867138",
      "accessToken": "ZVBgqvxLU7gO7-HL_riMnvhzf42AIQwqiLA9Jwlrytr765XZKe3wWghNd0vhFXgscoeiIdAvmtqUBGr6RhRQCAoisMLubaPr2ItfLrE4D2cnRxcselxe_Tb19-kOIXuQdzfkbxahVgL0twQogDHak39pUD_wMeOAiaROvgqHuD4="
    }
  }
}
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
