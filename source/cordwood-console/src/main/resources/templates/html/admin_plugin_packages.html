<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<title th:text="#{site.title.plugins}">插件管理</title>
<meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
<meta name="description" content="">
<meta name="author" content="">
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_param" th:content="${_csrf.parameterName}"/>
<link rel="stylesheet" type="text/css" href="../../static/js/bootstrap-switch/bootstrap-switch.min.css"
    th:href="@{~/js/bootstrap-switch/bootstrap-switch.min.css}" />
<link rel="stylesheet" type="text/css" href="../../static/css/cloud-admin.css"
    th:href="@{~/css/cloud-admin.css}" />
<link rel="stylesheet" type="text/css" href="../../static/css/themes/default.css" id="skin-switcher"
    th:href="@{~/css/themes/default.css}" />
<link rel="stylesheet" type="text/css" href="../../static/css/responsive.css"
    th:href="@{~/css/responsive.css}" />
<link rel="stylesheet" type="text/css" href="../../static/font-awesome/css/font-awesome.min.css"
    th:href="@{~/font-awesome/css/font-awesome.min.css}" />
<link rel="stylesheet" type="text/css" href="../../static/js/dropzone/dropzone.min.css"
    th:href="@{~/js/dropzone/dropzone.min.css}" />
<link rel="stylesheet" type="text/css" href="../../static/bootstrap-table/bootstrap-table.css"
    th:href="@{~/bootstrap-table/bootstrap-table.css}" />
<link rel="stylesheet" type="text/css" href="../../static/cordwood/css/cordwood.css"
    th:href="@{~/cordwood/css/cordwood.css}" />
</head>
<body>
    <!-- HEADER -->
    <header class="navbar clearfix" id="header">
        <div class="container" th:replace="admin_header.html :: header"></div>
        <!-- /TEAM STATUS -->
    </header>
    <!--/HEADER -->
    <!-- PAGE -->
    <section id="page">
        <!-- SIDEBAR -->
        <div id="sidebar" class="sidebar">
            <div class="sidebar-menu nav-collapse" th:replace="admin_sidebar.html :: sidebar"></div>
        </div>
        <!-- /SIDEBAR -->
        <div id="main-content">
            <div class="container">
                <div class="row">
                    <div id="content" class="col-md-12">
                        <div class="page-header" style="overflow: visible;">
                            <ul class="breadcrumb" th:replace="admin_navbar.html :: navbar">
                                <li>插件管理</li>
                            </ul>
                        </div>
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="panel panel-default">
                                    <div class="panel-body">
                                        <div id="toolbar">
                                            <div class="btn-group pull-left">
                                                <a href="#" th:href="@{~/admin/plugins/logs}" class="btn btn-default">
                                                    <i class="fa fa-history"></i> 访问日志
                                                </a>
                                                <a href="#uploadPlugin" data-toggle="modal" class="btn btn-default">
                                                    <i class="fa fa-cloud-upload"></i> 上传插件
                                                </a>
                                            </div>
                                        </div>
                                        <table id="dataTable"></table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <div class="modal fade" id="uploadPlugin" tabindex="-1" role="dialog"
        aria-labelledby="uploadPlugin" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">上传新插件（最多同时上传5个插件包）</h4>
                </div>
                <div class="modal-body">
                    <div class="dropzone" id="dropzone">
                        <div class="fallback">
                            <input name="files" type="file" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="submitBtn">上传</button>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="../../static/js/jquery/jquery-2.0.3.min.js"
        th:src="@{~/js/jquery/jquery-2.0.3.min.js}"></script>
    <script type="text/javascript"
        src="../../static/js/jquery-ui-1.10.3.custom/js/jquery-ui-1.10.3.custom.min.js"
        th:src="@{~/js/jquery-ui-1.10.3.custom/js/jquery-ui-1.10.3.custom.min.js}"></script>
    <script type="text/javascript" src="../../static/bootstrap/js/bootstrap.min.js"
        th:src="@{~/bootstrap/js/bootstrap.min.js}"></script>
    <script type="text/javascript"
        src="../../static/js/jQuery-slimScroll-1.3.0/jquery.slimscroll.min.js"
        th:src="@{~/js/jQuery-slimScroll-1.3.0/jquery.slimscroll.min.js}"></script>
    <script type="text/javascript"
        src="../../static/js/jQuery-slimScroll-1.3.0/slimScrollHorizontal.min.js"
        th:src="@{~/js/jQuery-slimScroll-1.3.0/slimScrollHorizontal.min.js}"></script>
    <script type="text/javascript" src="../../static/js/jQuery-BlockUI/jquery.blockUI.min.js"
        th:src="@{~/js/jQuery-BlockUI/jquery.blockUI.min.js}"></script>
    <script type="text/javascript" src="../../static/js/bootstrap-switch/bootstrap-switch.min.js"
        th:src="@{~/js/bootstrap-switch/bootstrap-switch.min.js}"></script>
    <script type="text/javascript" src="../../static/js/dropzone/dropzone.min.js"
        th:src="@{~/js/dropzone/dropzone.min.js}"></script>    
    <script type="text/javascript" src="../../static/js/jQuery-Cookie/jquery.cookie.min.js"
        th:src="@{~/js/jQuery-Cookie/jquery.cookie.min.js}"></script>
    <script type="text/javascript" src="../../static/bootstrap-table/bootstrap-table.js"
        th:src="@{~/bootstrap-table/bootstrap-table.js}"></script>
    <script type="text/javascript" src="../../static/bootstrap-table/bootstrap-table-zh-CN.js"
        th:src="@{~/bootstrap-table/bootstrap-table-zh-CN.js}"></script>
    <script type="text/javascript" src="../../static/cordwood/js/common-init.js"
        th:src="@{~/cordwood/js/common-init.js}"></script>
    <script type="text/javascript" src="/admin/sidebar.js"></script>
    <script>
          jQuery(document).ready(function() {
            loadSidebarItems('plugins');
          });

          $('#dataTable').bootstrapTable({
            url: '/admin/plugin_packages.json',
            toolbar: '#toolbar',
            sidePagination: 'server',
            showRefresh: true,
            pageSize: 20,
            pageList: [20,50,100],
            showColumns: true,
            search: true,
            pagination: true,
            sortName: 'createTime',
            sortOrder: 'desc',
            columns: [{
                field: 'id',
                title: '标识符',
                sortable: true,
                valign: 'middle',
                visible: false
            }, {
                field: 'fileName',
                title: '文件名',
                valign: 'middle',
                sortable: true,
                visible:false
            }, {
                field: 'description',
                title: '插件包',
                valign: 'middle',
                sortable: true,
                formatter: function (value, row, index) {
                    return '<a href="/admin/plugin_package_details?package_id=' + row.id + '">' + value + '</a>';
                }
            }, {
                field: 'developer',
                title: '开发者',
                valign: 'middle',
                sortable: true
            }, {
                field: 'createTime',
                title: '创建时间',
                valign: 'middle',
                sortable: true
            }, {
                title: '操作',
                valign: 'middle',
                sortable: false,
                formatter: function (value, row, index) {
                    return '<a class="text-danger" href="javascript:uninstall(\''+row.id+'\');">卸载</a>';
                }
            }]
        });
        function uninstall(pid) {
          if (confirm('确定要卸载此插件包?')) {
            var url = '/admin/plugin_packages/uninstall?package_id='+pid;
            $.get(url, function(data, status, xhr) {
              if (xhr.status == 200) {
                var param = {field: 'id', values: [pid]};
                $('#dataTable').bootstrapTable('remove', param);
              }
            });
          }
        }
        Dropzone.autoDiscover = false;
        $('#dropzone').dropzone({
          url: '/admin/plugin_packages/upload',
          paramName: 'files',
          acceptedFiles: '.jar,.JAR',
          maxFiles: 5,
          autoProcessQueue: false,
          uploadMultiple: true,
          maxFilesize: 10, // MB
          addRemoveLinks: true,
          dictInvalidFileType: '文件格式不正确，请上传 .jar 格式的插件包文件！',
          dictRemoveFile: '删除',
          dictResponseError: '上传出现错误！',
          dictFileTooBig: '文件太大！',
          dictFallbackMessage: '您的浏览器不支持拖拽上传！',
          dictDefaultMessage: '拖拽文件来上传',
          dictMaxFilesExceeded: '文件个数超出限制！',
          init: function() {
            myDropzone = this;
            $('#submitBtn').click(function(event) {
              myDropzone.processQueue();
            });
            this.on("sending", function(file, jqXHR, data) {
              var param = $("meta[name='_csrf_param']").attr("content");
              var token = $("meta[name='_csrf']").attr("content");
              data.append(param, token);
            });
            this.on("success", function(file) {
              $("#uploadPlugin").modal('hide');
              $('#dataTable').bootstrapTable('refresh', {silent: true});
              alert('插件上传成功!');
            });
          }
        });
      </script>
    <!-- /JAVASCRIPTS -->
</body>
</html>